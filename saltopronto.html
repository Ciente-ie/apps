<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Salto Pronto</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
    button { font-size: 18px; margin: 10px; padding: 10px 20px; }
    #status { margin-top: 20px; font-size: 24px; font-weight: bold; }
    canvas { max-width: 100%; }
  </style>
</head>
<body>
  <h1>Salto Pronto</h1>
  <p>Escolha o tipo de teste:</p>
  <button onclick="tipoTeste = 1; iniciarTeste(1)">Teste de 1 salto</button>
  <button onclick="tipoTeste = 10; iniciarTeste(10)">Teste de 10 saltos</button>
  <button onclick="cancelarTeste()">Cancelar Teste</button>

  <div id="status">Aguardando início...</div>
  <canvas id="grafico" width="400" height="200"></canvas>
  <p>
    Fator de correção (%): 
    <input type="number" id="fatorInput" value="100" onchange="atualizarFator()" style="width: 80px;">
  </p>
  <script>
    let tipoTeste = 0;
    let fator = 1;
    let statusDiv = document.getElementById("status");
    let ctx = document.getElementById("grafico").getContext("2d");
    let dados = [];
    let testeEmAndamento = false;
    let saltos = [];

    function atualizarFator() {
      let input = document.getElementById("fatorInput").value;
      fator = parseFloat(input) / 100;
    }

    function iniciarTeste(tipo) {
      if (testeEmAndamento) return;
      tipoTeste = tipo;
      saltos = [];
      dados = [];
      testeEmAndamento = true;
      statusDiv.innerText = `Iniciando teste de ${tipo} salto(s)...`;
      proximoSalto();
    }

    function cancelarTeste() {
      testeEmAndamento = false;
      statusDiv.innerText = "Teste cancelado.";
      window.removeEventListener('devicemotion', motionHandlerGlobal);
    }

    function proximoSalto() {
      if (!testeEmAndamento) return;
      if (saltos.length >= tipoTeste) {
        finalizarTeste();
        return;
      }
      statusDiv.innerText = `Aguardando salto ${saltos.length + 1}...`;
      capturarSalto((altura, tempoVoo) => {
        saltos.push({ altura, tempoVoo });
        proximoSalto();
      });
    }

    function finalizarTeste() {
      testeEmAndamento = false;
      let alturas = saltos.map(s => s.altura);
      let medias = calcularMedias(alturas);
      let resultado = `Média: ${medias.media.toFixed(2)} cm`;
      if (tipoTeste === 10) {
        resultado += `\n3 primeiros: ${medias.mediaInicio.toFixed(2)} cm`;
        resultado += `\n3 últimos: ${medias.mediaFim.toFixed(2)} cm`;
        let diferenca = medias.mediaFim - medias.mediaInicio;
        let percentual = (diferenca / medias.mediaInicio) * 100;
        resultado += `\nDiferença: ${percentual.toFixed(1)}%`;
        if (Math.abs(percentual) <= 5) {
          resultado += `\nO atleta manteve o desempenho durante o teste.`;
        } else if (percentual > 5) {
          resultado += `\nO atleta melhorou o desempenho.`;
        } else {
          resultado += `\nO atleta teve queda de desempenho.`;
        }
      }
      alert(resultado);
      statusDiv.innerText = "Teste finalizado.";
    }

    function calcularMedias(arr) {
      let media = arr.reduce((a, b) => a + b, 0) / arr.length;
      let mediaInicio = arr.slice(0, 3).reduce((a, b) => a + b, 0) / 3;
      let mediaFim = arr.slice(-3).reduce((a, b) => a + b, 0) / 3;
      return { media, mediaInicio, mediaFim };
    }

    function capturarSalto(callback) {
      let saltou = false;
      let tDecolagem = 0;

      function motionHandler(e) {
        const acc = e.accelerationIncludingGravity;
        const now = Date.now();
        const modulo = Math.sqrt(acc.x ** 2 + acc.y ** 2 + acc.z ** 2);

        if (tipoTeste === 1 || tipoTeste === 10) {
          plotar(modulo);
        }

        if (!saltou && modulo < 3) {
          saltou = true;
          tDecolagem = now;
          statusDiv.innerText = 'No ar!';
        }

        if (saltou && modulo > 10) {
          const tPouso = now;
          const tempoVoo = (tPouso - tDecolagem) / 1000;
          const altura = (9.81 * tempoVoo * tempoVoo) / 8 * 100 * fator;
          statusDiv.innerText = 'Salto registrado!';
          window.removeEventListener('devicemotion', motionHandler);
          if (callback) callback(altura, tempoVoo);
        }
      }

      if (typeof DeviceMotionEvent.requestPermission === 'function') {
        DeviceMotionEvent.requestPermission().then(permissionState => {
          if (permissionState === 'granted') {
            window.addEventListener('devicemotion', motionHandler);
          } else {
            alert('Permissão negada para acessar o acelerômetro.');
          }
        }).catch(console.error);
      } else {
        window.addEventListener('devicemotion', motionHandler);
      }
    }

    function plotar(valor) {
      dados.push(valor);
      if (dados.length > 50) dados.shift();
      ctx.clearRect(0, 0, 400, 200);
      ctx.beginPath();
      ctx.moveTo(0, 200 - dados[0]);
      for (let i = 1; i < dados.length; i++) {
        ctx.lineTo(i * (400 / 50), 200 - dados[i]);
      }
      ctx.stroke();
    }
  </script>
</body>
</html>
